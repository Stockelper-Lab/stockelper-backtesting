version: "3.8"

services:
  backtesting-server:
    container_name: stockelper-backtesting-server
    image: stockelper-backtesting-server:latest
    build:
      context: .
    ports:
      - "21007:21007"
    environment:
      # Server
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-21007}
      DEBUG: ${DEBUG:-false}
      # Python path (src 레이아웃)
      PYTHONPATH: /app/src

      # DB (stockelper-fe Prisma의 DATABASE_URL과 호환되도록 둘 다 지원)
      DATABASE_URL: ${DATABASE_URL:-}
      ASYNC_DATABASE_URL: ${ASYNC_DATABASE_URL:-}
      # 결과 파일 (artifact 다운로드용)
      BACKTEST_RESULTS_DIR: ${BACKTEST_RESULTS_DIR:-outputs/backtesting_results}
    volumes:
      # worker가 저장한 결과 파일을 서버도 읽을 수 있도록 공유
      - backtest_outputs:/app/outputs/backtesting_results

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:21007/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - stockelper
    restart: unless-stopped

  backtest-worker:
    container_name: stockelper-backtest-worker
    build:
      context: .
    command: [".venv/bin/python", "-m", "backtesting.worker"]
    environment:
      # Result DB (stockelper_web - 잡/결과/해석 저장)
      DATABASE_URL: ${DATABASE_URL:-}
      ASYNC_DATABASE_URL: ${ASYNC_DATABASE_URL:-}
      
      # Source Data DB (주가/공시/지표 조회)
      # 주의: Docker 네트워크 내부에서는 컨테이너 내부 포트(5432)를 사용해야 함
      # .env의 DB_PORT(21002)는 호스트→컨테이너 매핑용이므로 여기선 5432 고정
      DB_USER: ${DB_USER:-stockelper}
      DB_PASSWORD: ${DB_PASSWORD:-}
      DB_HOST: ${DB_HOST:-stockelper-postgresql}
      DB_PORT: "5432"
      DB_NAME: ${DB_NAME:-postgres}
      
      # Python path (src 레이아웃)
      PYTHONPATH: /app/src

      # LLM (해석 트리거)
      STOCKELPER_LLM_URL: ${STOCKELPER_LLM_URL:-}
      BACKTEST_LLM_TRIGGER_TIMEOUT: ${BACKTEST_LLM_TRIGGER_TIMEOUT:-10}

      # Worker runtime
      BACKTEST_SIMULATE_SECONDS: ${BACKTEST_SIMULATE_SECONDS:-300}
      BACKTEST_WORKER_POLL_SECONDS: ${BACKTEST_WORKER_POLL_SECONDS:-5}
      BACKTEST_RESULTS_DIR: ${BACKTEST_RESULTS_DIR:-outputs/backtesting_results}
    volumes:
      - backtest_outputs:/app/outputs/backtesting_results
    depends_on:
      - backtesting-server
    networks:
      - stockelper
    restart: unless-stopped

networks:
  stockelper:
    external: true
    name: stockelper

volumes:
  backtest_outputs:


