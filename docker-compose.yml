version: "3.8"

services:
  backtesting-server:
    container_name: stockelper-backtesting-server
    image: stockelper-backtesting-server:latest
    build:
      context: .
    ports:
      - "21007:21007"
    environment:
      # Server
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-21007}
      DEBUG: ${DEBUG:-false}
      # Python path (src 레이아웃)
      PYTHONPATH: /app/src

      # DB (stockelper-fe Prisma의 DATABASE_URL과 호환되도록 둘 다 지원)
      DATABASE_URL: ${DATABASE_URL:-}
      ASYNC_DATABASE_URL: ${ASYNC_DATABASE_URL:-}
      # 결과 파일 (artifact 다운로드용)
      BACKTEST_RESULTS_DIR: ${BACKTEST_RESULTS_DIR:-outputs/backtesting_results}
    volumes:
      # worker가 저장한 결과 파일을 서버도 읽을 수 있도록 공유
      - backtest_outputs:/app/outputs/backtesting_results

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:21007/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - stockelper
    restart: unless-stopped

  backtest-worker:
    container_name: stockelper-backtest-worker
    build:
      context: .
    command: [".venv/bin/python", "-m", "backtesting.worker"]
    environment:
      # Result DB (stockelper_web - 잡/결과/해석 저장)
      DATABASE_URL: ${DATABASE_URL:-}
      ASYNC_DATABASE_URL: ${ASYNC_DATABASE_URL:-}
      
      # Source Data DB (주가/공시/지표 조회)
      # 10.0.10.230:21002의 postgres DB에 연결
      DB_USER: ${DB_USER:-stockelper}
      DB_PASSWORD: ${DB_PASSWORD:-stockelper1!}
      DB_HOST: ${DB_HOST:-10.0.10.230}
      DB_PORT: ${DB_PORT:-21002}
      DB_NAME: ${DB_NAME:-postgres}
      
      # Python path (src 레이아웃)
      PYTHONPATH: /app/src

      # LLM (해석 트리거)
      STOCKELPER_LLM_URL: ${STOCKELPER_LLM_URL:-}
      BACKTEST_LLM_TRIGGER_TIMEOUT: ${BACKTEST_LLM_TRIGGER_TIMEOUT:-10}

      # Worker runtime
      BACKTEST_SIMULATE_SECONDS: ${BACKTEST_SIMULATE_SECONDS:-300}
      BACKTEST_WORKER_POLL_SECONDS: ${BACKTEST_WORKER_POLL_SECONDS:-5}
      BACKTEST_RESULTS_DIR: ${BACKTEST_RESULTS_DIR:-outputs/backtesting_results}

      # (선택) OpenAI Agents SDK 기반 오케스트레이션
      BACKTEST_USE_AGENTS: ${BACKTEST_USE_AGENTS:-false}
      BACKTEST_AGENT_MAX_RETRIES: ${BACKTEST_AGENT_MAX_RETRIES:-2}
      BACKTEST_AGENT_PROMPT_VERSION: ${BACKTEST_AGENT_PROMPT_VERSION:-v1}
      BACKTEST_AGENT_MODEL_PARSE: ${BACKTEST_AGENT_MODEL_PARSE:-}
      BACKTEST_AGENT_MODEL_ADJUST: ${BACKTEST_AGENT_MODEL_ADJUST:-}
      BACKTEST_AGENT_MODEL_AUDIT: ${BACKTEST_AGENT_MODEL_AUDIT:-}
      BACKTEST_AGENT_MODEL_REPORT: ${BACKTEST_AGENT_MODEL_REPORT:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_DEFAULT_MODEL: ${OPENAI_DEFAULT_MODEL:-}
      OPENAI_AGENTS_TRACE_INCLUDE_SENSITIVE_DATA: ${OPENAI_AGENTS_TRACE_INCLUDE_SENSITIVE_DATA:-}
    volumes:
      - backtest_outputs:/app/outputs/backtesting_results
    depends_on:
      - backtesting-server
    networks:
      - stockelper
    restart: unless-stopped

networks:
  stockelper:
    external: true
    name: stockelper

volumes:
  backtest_outputs:


